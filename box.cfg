[serial_485 serial485]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
baud: 230400

[auto_addr]

[box]
bus:serial485
filament_sensor:filament_sensor_2
pre_cut_pos_x:5#223.8  
pre_cut_pos_y:200
cut_pos_x:5#223.8    
cut_pos_y:218.3#18.5#219.5#220
cut_pos_offset:1.3
cut_find_start_offset_y: 6
#middle_cut_pos_y:
Tn_retrude:-20#-1.00#-60       
Tn_retrude_velocity:5000#360  
Tn_extrude_temp: 220  #挤出温度
Tn_extrude: 140    #如果当前温度设置温度，预加热刀120
Tn_extrude_velocity: 500  #挤出速度
buffer_empty_len: 10  #缓冲器回抽预留长度，需要挤出缓冲器预留的长度 （切断挤出机内撞刀到挤出齿轮的长度）
clean_left_pos_x:153.5#铁氟龙擦嘴的左位置
clean_left_pos_y:217#217#217#217
clean_right_pos_x:154.0#铁氟龙擦嘴的右位置
clean_right_pos_y:217#217#217#217
clean_velocity: 3600
cut_velocity:12000
#cut_accel:10000
#cut_accel_to_decel:30000

extrude_pos_x:159.0#159.0
extrude_pos_y:217.5#217.5
box_first_clean_length:140
box_need_clean_length:140
box_need_clean_length_max:140
has_extrude_pos: 1          #有没有吐料需要  区分K1_MAX和f008
safe_pos_y: 200#200#200
# switch_pin:!nozzle_mcu:PB9
#switch_pin:!nozzle_mcu:PA8
switch_pin:nozzle_mcu:PA8
#cr_machine: 1 # default: 0: F008 / 1: K1SE
version: 1
extrude_pos_z:33.0
cut_run_count:1
tn_line_len:40.00
box_extrude_retry_num: 5
retrude_position_x: 42
retrude_position_y: 100

[gcode_macro pre_cut_box]
variable_pre_cut_retrusion: 27 # mm, heatbreak filament length, so there is approx 65-37 = 28 mm filament left in the nozzle after cutting
variable_pre_cut_retrusion_speed: 33 
variable_max_wait_for_preload: 30 # sec, timout for preload
variable_extrude_before_purge: 34 # mm, how much to extrude before moving to the purge tower. We need some pressure there to not print have large holes in the purge tower
variable_purge_speed: 15 # volumetric speed mm3/s
gcode:
 ; placeholder – no commands

[gcode_macro T0]
rename_existing: T0.0
gcode:
  SWAP_FILAMENT SLOT=T1A {rawparams}

[gcode_macro T1]
rename_existing: T1.0
gcode: 
  SWAP_FILAMENT SLOT=T1B {rawparams}

[gcode_macro T2]
rename_existing: T2.0
gcode: 
  SWAP_FILAMENT SLOT=T1C {rawparams}

[gcode_macro T3]
rename_existing: T3.0
gcode: 
  SWAP_FILAMENT SLOT=T1D {rawparams}


[gcode_macro BOX_GOTO_HOPPER]
gcode:
  {% set x_extrude = printer.configfile.settings.box.extrude_pos_x %}
  {% set y_extrude = printer.configfile.settings.box.extrude_pos_y %}
  {% set z_extrude = printer.configfile.settings.box.extrude_pos_z %}
  {% set y_safe = printer.configfile.settings.box.safe_pos_y %}  

  {% if printer.toolhead.position.z < z_extrude %}
    G1 Z{z_extrude} F600
  {% endif %}  
  G1 X{x_extrude} Y{y_safe} F20000
  G1 Y{y_extrude} F1200

   
[gcode_macro GET_MODE]
description: Get and store human-readable mode from T1â€“T4 in printer['box']
variable_mode_str: ""
gcode:
    {% set tnum = params.T|int %}
    {% if tnum not in [1,2,3,4] %}
        {action_respond_info("Invalid parameter. Use T=1..4")}
    {% else %}
        {% set MODE_ENUM = {
            "0": "IDLE",
            "1": "PRELOADING",
            "2": "PRINTING",
            "3": "WRAPPERING",
            "4": "ERR",
            "5": "TEST"
        } %}
        {% set box = printer['box'] %}
        {% set key = "T" ~ tnum %}
        {% set raw_mode = box[key]["mode"]|string %}
        {% set mode_str = MODE_ENUM.get(raw_mode, "UNKNOWN") %}
        SET_GCODE_VARIABLE MACRO=GET_MODE VARIABLE=mode_str VALUE="{% raw %}'{{ mode_str }}'{% endraw %}"
        #{action_respond_info(key ~ " mode = " ~ mode_str)}
    {% endif %}

[gcode_macro CHECK_PRELOADING]
description: Check if any of T1â€“T4 is in PRELOADING mode and save result
variable_any_preloading: False
gcode:
    {% set box = printer['box'] %}
    {% set preloading = False %}
    {% for t in [1, 2, 3, 4] %}
        {% set mode = box["T" ~ t]["mode"]|string %}
        {% if mode == "1" %} ; 1 = PRELOADING
            {% set preloading = True %}
        {% endif %}
    {% endfor %}

    SET_GCODE_VARIABLE MACRO=CHECK_PRELOADING VARIABLE=any_preloading VALUE={preloading}
    {action_respond_info("Any preloading: " ~ preloading|string)}


[gcode_macro BOX_PRE_CUT_RETRUDE]
description: Retract the currently loaded filament from the nozzle prior to cutting
gcode:
  {% set pre_retract = params.PRERETRACT|default(0)|float %} #already retruded length due to the gcode executed before toolchange
  {% set pre_cut_retrusion = printer["gcode_macro pre_cut_box"].pre_cut_retrusion - pre_retract - 8|float %} # -8 due to CFS CUT retruding an additionnal 8 mm and  -pre_retract done prior to
  {% set pre_cut_retrusion_speed = printer["gcode_macro pre_cut_box"].pre_cut_retrusion_speed %} 
  {% set buffer_empty_len = printer.configfile.settings.box.buffer_empty_len %}
  {% set svv = printer.save_variables.variables %}
  {% set cur_slot = svv.currentcfsslot %}

  {% if printer["filament_switch_sensor filament_sensor_2"].filament_detected %}

  RESPOND MSG="BOX_PRE_CUT_RETRUDE: pre_retract:{pre_retract} pre_cut_retrusion:{pre_cut_retrusion}"
  {% if (not printer.extruder.can_extrude) %}
    {% set temperature = params.TEMP|default(printer.configfile.settings.box.tn_extrude_temp)|float %} 
    RESPOND MSG="extruder can't extrude, heating to {temperature}"
    M109 S{temperature}
  {% endif %}
      
  {% set buffer_len = 2*buffer_empty_len %} # Their weird logic. The actual buffer size is twice this attribute
  {% set loops = (pre_cut_retrusion // buffer_len) | int %} # Amount of times the buffer has to be retruded
  {% set remainder = pre_cut_retrusion - buffer_len * loops %}

  BOX_SET_BOX_MODE ADDR={cur_slot[1]} MODE="IDLE" # Box needs to be in idle mode to control the buffer
  # the first retrusion are all buffer_len
  {% for i in range(loops) %}    
    BOX_RETRUDE_PROCESS ADDR={cur_slot[1]} NUM="{cur_slot[2]}" TRIGGER="BUFFER" # run the buffer to the "empty" position
    RESPOND MSG="Retruding: {buffer_len}"
    G91
    G1 E-{buffer_len} F{pre_cut_retrusion_speed*60}
    G90
    M400
  {% endfor %}
  {% else %}
  RESPOND MSG="Warning: Tried to retrude without material detected. Skipped."
  {% endif %}

  BOX_RETRUDE_PROCESS ADDR={cur_slot[1]} NUM="{cur_slot[2]}" TRIGGER="BUFFER" # run the buffer to the "empty" position
  RESPOND MSG="Retruding: {buffer_len}"
  G91
  G1 E-{remainder} F{pre_cut_retrusion_speed*60}
  G90
  M400


[gcode_macro SWAP_FILAMENT]
gcode:  
  {% set box = printer.configfile.settings.box %}
  {% set pre_cut_box = printer["gcode_macro pre_cut_box"]  %}
  {% set svv = printer.save_variables.variables %}

  {% set purge_length = params.LEN|default(0)|float + pre_cut_box.extrude_before_purge %} # the latter to get filament just oozing out of the nozzle. The first is the actual purge
  {% set purge_feedrate = params.F|default(pre_cut_box.purge_speed*60/2.405)|float %}

  {% set after_purge_retract = params.RETRACT|default(0.4)|float %}
  {% set pre_toolchange_retract = params.PRERETRACT|default(0)|float %} # how many mm were retracted before the toolchange

  {% set temperature = params.S|default(printer.configfile.settings.box.tn_extrude_temp)|float %}
  {% set slot = params.SLOT|default("T1A") %}

  {% set max_wait_for_preload = pre_cut_box.max_wait_for_preload | int %} # Timeout

  {% set y_safe = printer.configfile.settings.box.safe_pos_y %}

  {% set current_slot = "None" if not printer["filament_switch_sensor filament_sensor_2"].filament_detected else svv.currentcfsslot %}
  RESPOND MSG="Current stored CFS slot: {current_slot} wanted: {slot}"
  {% if current_slot != slot %}
    RESPOND MSG="Swap to {slot}"
    
    {% if printer.toolhead.homed_axes != "xyz" %}
      RESPOND MSG="Axes not homed - performing homing..."
      M109 S140
      G28
    {% endif %}

    {% set saved_z = printer.toolhead.position.z %} # This is only necessary when using Orca Slicer pre 2.3.2

    BOX_ERROR_CLEAR # Internal error state cleared
    {% if saved_z <= 2 %} # If we start at z=0 avoid problems
      G1 Z{saved_z+2} F480
    {% endif %}

    # Preloading is when there is a filament put in the CFS and the CFS moves the filament through the tube to the extruder and back. It rarely happens that anyone would do that and issue this command but if so, we have to wait.
    CHECK_PRELOADING 
    {% set is_preloading = printer["gcode_macro CHECK_PRELOADING"].variable_any_preloading %}
    {% if is_preloading %}
      {% for i in range(max_wait_for_preload) %}
        {% if is_preloading %}
          G4 P1000 # wait a second
          CHECK_PRELOADING
          {% set is_preloading = printer["gcode_macro CHECK_PRELOADING"].variable_any_preloading %}
        {% else %}
          {% set preloading_finished = True %}
        {% endif %}          
      {% endfor %}
      
      {% if is_preloading %}
        {action_raise_error("Preloading seems to have failed. Is something jammed?")}
      {% endif %}
    {% endif %} 

    # Progressive filament retraction using a while loop, making sure CFS retracts the filament from the buffer progressively
    {% if current_slot != "None" %}
    BOX_PRE_CUT_RETRUDE {rawparams} CUR_SLOT=current_slot    
    # CUT the filament with block
    BOX_CUT_MATERIAL
    {% endif %}
    # Got to extrude position
    BOX_GOTO_HOPPER    
    # Swap filament
    BOX_RETRUDE_MATERIAL
    BOX_EXTRUDE_MATERIAL TNN={slot}
    BOX_EXTRUDER_EXTRUDE TNN={slot}
    # Purge filament
    G91
    G1 E{purge_length} F{purge_feedrate}
    G90
    M400

    # Cool purge for 2 seconds
    {% set fan0_saved = printer["output_pin fan0"].value %}
    RESPOND MSG="saved {fan0_saved}"    
    {% set old_accel = printer.toolhead.max_accel %}
    {% set old_accel_to_decel = printer.toolhead.max_accel_to_decel %} 
    M106 S{200}
    G4 P2000
    # We need extra accel to make the hopper eject properly
    SET_VELOCITY_LIMIT ACCEL=20000 ACCEL_TO_DECEL=20000
    G1 Y{y_safe} F30000
    # Restore
    SET_VELOCITY_LIMIT ACCEL={old_accel} ACCEL_TO_DECEL={old_accel_to_decel}
    M106 S{fan0_saved * 255}

    # Move away from hopper. Purge should fall to the back
    G91
    G1 E-{after_purge_retract} F2400 # compensate for gcode filament retraction prior to the toolchange. The slicer thinks the filament is retraced and will extrude it later again.
    G90
    G1 Z{saved_z} F600 # This is only necessary when using Orca Slicer pre 2.3.2
    M400

    # Set new Material
    SAVE_VARIABLE VARIABLE=currentcfsslot VALUE='"{slot}"'
  {% endif %}

[gcode_macro BOX_LOAD_MATERIAL_WITH_MATERIAL]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set current_slot = svv.currentcfsslot %}
  M104
  IF_NEED_HOME
  BOX_ERROR_CLEAR
  BOX_PRE_CUT_RETRUDE CUR_SLOT={current_slot} PRERETRACT=0
  BOX_CUT_MATERIAL
  BOX_RETRUDE_MATERIAL
  #BOX_GO_TO_EXTRUDE_POS
  BOX_GOTO_HOPPER
  #BOX_NOZZLE_CLEAN
  #RESPOND MSG="BOX_NOZZLE_CLEAN"
  BOX_EXTRUDE_MATERIAL
  BOX_EXTRUDER_EXTRUDE
  BOX_MATERIAL_FLUSH
  RESTORE_POSITION
  SAVE_VARIABLE VARIABLE=currentcfsslot VALUE='"None"'

[gcode_macro BOX_LOAD_MATERIAL_WITHOUT_MATERIAL]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set current_slot = svv.currentcfsslot %}
  M104
  BOX_CHECK_MATERIAL
  BOX_EXTRUDE_MATERIAL
  BOX_EXTRUDER_EXTRUDE
  BOX_MATERIAL_FLUSH
  SAVE_VARIABLE VARIABLE=currentcfsslot VALUE='"None"'


[gcode_macro BOX_QUIT_MATERIAL]
description: called when calling 'Retract' from the display
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set current_slot = svv.currentcfsslot %}
  BOX_ERROR_CLEAR
  BOX_PRE_CUT_RETRUDE CUR_SLOT={current_slot} PRERETRACT=0
  BOX_CUT_MATERIAL
  BOX_RETRUDE_MATERIAL
  SAVE_VARIABLE VARIABLE=currentcfsslot VALUE='"None"'

[gcode_macro BOX_INFO_REFRESH]
gcode:
  BOX_SET_PRE_LOADING ADDR={params.ADDR} NUM={params.NUM} ACTION=RUN
  M400
  BOX_GET_RFID ADDR={params.ADDR} NUM={params.NUM}
  M400
  BOX_GET_REMAIN_LEN ADDR={params.ADDR} NUM={params.NUM}
  M400

